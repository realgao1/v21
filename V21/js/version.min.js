if (window.plus) {
    plusReady();
} else {
    document.addEventListener('plusready', plusReady, false);
}
//获取远程版本


var wgtVer = null;

function plusReady() {
   $.ajax({
   	url:"http://121.42.14.187/v/ky/ver",
   	type:"GET",
   	async:false,
   	success:function(data){
   		var checkUrl=data.ver;
		var Url = data.url;
   		console.log("版本号："+checkUrl+",Url是:"+Url);
   		// 获取本地应用资源版本号
   		plus.runtime.getProperty(plus.runtime.appid, function(inf) {
   		    wgtVer = inf.version;
			if(wgtVer != checkUrl){
				console.log("需要更新："+checkUrl);
				downWgt(Url);
			}
   		});
   	}
   });
}

function plusReady_confirm() {
	var ver_num;
		$.ajax({
		url:"http://121.42.14.187/v/ky/ver",
		type:"GET",
		async:false,
		success:function(data){
			var checkUrl=data.ver;
			var Url = data.url;
			ver_num=checkUrl;
			// 获取本地应用资源版本号
			plus.runtime.getProperty(plus.runtime.appid, function(inf) {
				wgtVer = inf.version;
				if(wgtVer != checkUrl){
					downWgt(Url);
				}else{
					vant.Dialog.alert({
					  message: '已经是最新版本！',
					  theme: 'round-button',
					}).then(() => {});
				}
			});
		}
   });
   return ver_num;
}


function downWgt(Url) {
    var cfi = confirm("检查到软件有更新，是否下载?");
    if (cfi == true) {
        plus.nativeUI.showWaiting("正在更新，请稍后...");
        var dtask = plus.downloader.createDownload(Url, {}, function(d, status) { 
				if (status == 200) {
					open(d.filename); // 打开下载地址
					installWgt(d.filename);
				} else {
					plus.nativeUI.alert("打开下载页面失败！");
				}
				plus.nativeUI.closeWaiting();
        });

        //下载事件监控
        dtask.addEventListener("statechanged", function(task, status) {
            if (!dtask) {
                return;
            }
            switch (task.state) {
                case 0:
                    console.log("未初始化!");
                    break;
                case 1:
                    console.log("开始下载!");
                    break;
                case 2:
                    console.log("连接到服务器!");
                    break;
                case 3:
                    console.log("接收数据!");
                    break;
                case 4:
                    console.log("下载完成!");
                    break;
            }
        });
        dtask.start();
    } else {

    }
}

//安装
function installWgt(path) {
    plus.nativeUI.showWaiting("安装wgt文件...");
    plus.runtime.install(path, {
		force: true
	}, function() {
        plus.nativeUI.closeWaiting();
        console.log("安装wgt文件成功！");
        plus.nativeUI.alert("应用资源更新完成！", function() {
            plus.runtime.restart();
        });
    }, function(e) {
        plus.nativeUI.closeWaiting();
        console.log("安装wgt文件失败[" + e.code + "]：" + e.message);
        plus.nativeUI.alert("安装wgt文件失败[" + e.code + "]：" + e.message);
    });
}