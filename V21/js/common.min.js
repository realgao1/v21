var comm_url = "http://121.42.14.187/v";
var page = ["index","live","setting"];
var resolve_address = "https://z1.m1907.cn/?jx=";
var scrolltab = ["排行榜","电影","电视剧","动漫","综艺","记录片"];
var dy = "55S15b2x";
var ds = "55S16KeG5Ymn";
var dm = "5Yqo5ryr";
var jl = "57qq5b2V54mH";
var zy = "57u86Im6";
var seh = "5pqC5peg";

function tab(n,m){
	shock(50); 
	window.location.href= page[m]+".html";
}
 
//返回顶部
function backTop(){
	$(".container").animate({scrollTop:"0px"},500);
}

//获取参数
function GetRequest() {  
   var url = location.search; 
   var theRequest = new Object();  
   if (url.indexOf("?") != -1) {  
	  var str = url.substr(1);  
	  strs = str.split("&");  
	  for(var i = 0; i < strs.length; i ++) {  
		 theRequest[strs[i].split("=")[0]]=unescape(strs[i].split("=")[1]);  
	  }  
   }  
   return theRequest;  
}  
//声明GetRequest
var req = GetRequest();

//page of feedback
var feedback_app = new Vue({
	el:"#feedback_app", 
	data: {
		active: 3,
		value: '',
		message: ''
	},
	methods: {
		onSubmit(val) {
			$.ajax({
				url:comm_url+"/base/iplay/addfeed1",
				type:'POST',
				dataType:'json',
				data: {"message":val.message},
				success:function(res){
					if(res.result == "success"){
						vant.Dialog.alert({
							message: '反馈成功,感谢您的参与！',
						}).then(() => {
							feedback_app.$set(feedback_app,'message', '');
						});
					}
				}
			});
		},
		toindex(){
			window.location.href="index.html";
		},
		tosetting(){
			window.location.href="setting.html";
		},
	},
});

function ky(val){
	if(val.toString().length > 0){
		set_cache(formatDateTime(new Date()),val);
		vant.Toast.loading({
			duration: 0,
			message: '全网搜索中   请稍候...',
			forbidClick: true,
		});
		var temp0 = [];
		var temp1 = [];
		$.ajax({
			url:"https://api.eyunzhu.com/api/vatfs/resource_site_collect/search?kw="+val+"&per_page=10&page=1",
			type:"GET",
			async:false,
			success:function(data){
				if(data.data.data.length > 0){
					vant.Toast.clear();
					$("#search_panel,#your_like").hide();
				}else{
					$("#search_panel,#your_like").show();
				}
				var aa = [];
				for(var i=0;i<data.data.data.length;i++){
					var online_search_obj={
						//"vid":data.data.data[i].vid,
						"video_name_cn":data.data.data[i].name,
						"video_cover":data.data.data[i].pic,
						"introduce":data.data.data[i].label,
						"resolve_code":"theme.html?vid="+data.data.data[i].vid
					};
					aa.push(online_search_obj);
				}
				search_app.$set(search_app,'resources', aa);
				temp0=aa;
				
				$.ajax({
					url:comm_url+"/base/showData/search?searchCode="+val,
					type:"GET",
					success:function(data){
						var bb = [];
						for(var i=0;i<data.length;i++){
							var ky_obj = {
								"video_name_cn":Base64.decode(data[i].video_name_cn).length > 6 ? Base64.decode(data[i].video_name_cn).substr(0,7)+'...' : Base64.decode(data[i].video_name_cn),
								"introduce": Base64.decode(data[i].introduce).length > 7 ? Base64.decode(data[i].introduce).substr(0,8)+'...' : Base64.decode(data[i].introduce),
								"video_cover":data[i].video_cover,
								"resolve_code":encodeURI(encodeURI("player.html?path=https://z1.m1907.cn/?jx@"
									+data[i].resolve_code
									+"&title="+Base64.decode(data[i].video_name_cn) 
									+"&intro="+Base64.decode(data[i].introduce)
									+"&online="+data[i].online_date
									+"&vid="+data[i].video_id
									+"&vtype=&diqu=&daoyan=&zhuyan=&gengduourl=&vt=5pqC5peg&page=1&vdefinition=SETpq5jmuIU=&autoplay=false"))
							};
							bb.push(ky_obj);
						}
						search_app.$set(search_app,'resources', bb.concat(temp0));
						temp1=bb;
					
						$.ajax({
							url:comm_url+"/ky/dtl?p="+val,
							type:"GET",
							success:function(data){
								vant.Toast.clear();
								if(data[0].result != 'wow'){
									var result = [];
									for(var i=0;i<data.length;i++){
										var ky_obj = {
											"video_name_cn":data[i].video_name_cn.length > 6 ? data[i].video_name_cn.substr(0,7)+'...' : data[i].video_name_cn,
											"introduce": data[i].introduce.length > 7 ? data[i].introduce.substr(0,8)+'...' : data[i].introduce,
											"video_cover":data[i].video_cover,
											"resolve_code":encodeURI(encodeURI(data[i].resolve_code))
										};
										result.push(ky_obj);
									}
									search_app.$set(search_app,'resources', result.concat(temp0).concat(temp1));
									$("#search_panel,#your_like").hide();
								}
							}
						});
					}
				});
			}
		});		
		search_app.$set(search_app,'cookies', getAllCache_24());
	}else{
		return '0';
	}
}

//page of search
var search_app = new Vue({
	el:"#search_app", 
	data: {
		active: 0,
		record_content_show: false,
		value: '',
		resources: [],
		cookies: [],
		mrc: [],
	},
	methods: {
		onSearch(val) {
			var rk = ky(val);
			if(rk == '0'){
				$("#sea_list").hide();
				$("#search_panel,#your_like").show();
				vant.Toast.fail('请输入关键词!');
			}else{
				$("#search_panel,#your_like").hide();
			}
		},
		clearRecord(){
			vant.Dialog.confirm({
				overlay: true,
				message: '您确定要清空搜索记录吗?\n搜索记录被清空后无法恢复哦！',
				confirmButtonColor: '#11cc24',
				cancelButtonColor: '#aaaaaa',
			}).then(() => {
				clearAllRecord();
				search_app.$set(search_app,'cookies', []);
			});
		},
		moreRecord() {
			search_app.$set(search_app,'record_content_show', true);
			var arr = getAllCache();
			search_app.$set(search_app,'mrc', arr);
			
		},
		delRec(val){
			remove_cache(val);
			search_app.$set(search_app,'mrc', getAllCache());
			search_app.$set(search_app,'cookies', getAllCache_24());
		},
		showCurRecord(){
			search_app.$set(search_app,'cookies', getAllCache_24());
		},
		shc(val) {
			vant.Toast(val+":功能待开发!");
		},
		toindex(){
			window.location.href="index.html";
		},
	},
});

function scrolltotop(){
	$(".container").animate({scrollTop:"0px"},0);
}	

res_load();

function res_load(){
	var tabs = ["rank",dy,ds,dm,zy,jl];
	var type = tabs[1];
	
	var dy_result=[];
	var currentPage;
	var totalitems;
	var itemsperpage;
	var pagecount;
	if(get_cache("indexdata_dy_result")) {
		dy_result = JSON.parse(get_cache("indexdata_dy_result"));
		currentPage = get_cache("indexdata_dy_currentPage");
		totalitems = get_cache("indexdata_dy_totalitems");
		itemsperpage = get_cache("indexdata_dy_itemsperpage");
		pagecount = get_cache("indexdata_dy_pagecount");
	}else{
		comms = get_res(dy,1);
		currentPage = comms.currentPage;
		dy_result = comms.result;
		totalitems = comms.totalitems;
		itemsperpage = comms.itemsperpage;
		pagecount = comms.pagecount;
		localStorage.setItem("indexdata_dy_result",JSON.stringify(dy_result));
		set_cache("indexdata_dy_currentPage",currentPage);
		set_cache("indexdata_dy_totalitems",totalitems);
		set_cache("indexdata_dy_itemsperpage",itemsperpage);
		set_cache("indexdata_dy_pagecount",pagecount);
	}
	
	var ds_result=[];
	var dm_result=[];
	var zy_result=[];
	var jl_result=[];
	var rank_result=get_list();
	var rank_search_result=[];
	
	if(get_cache("indexdata_ds_result") != null){
		ds_result = JSON.parse(get_cache("indexdata_ds_result"));
	}else{
		ds_result = get_res(ds,1).result;
		localStorage.setItem("indexdata_ds_result",JSON.stringify(ds_result));
	}
	
	if(get_cache("indexdata_dm_result") != null){
		dm_result = JSON.parse(get_cache("indexdata_dm_result"));
	}else{
		dm_result = get_res(dm,1).result;
		localStorage.setItem("indexdata_dm_result",JSON.stringify(dm_result));
	}
	
	if(get_cache("indexdata_zy_result") != null){
		zy_result = JSON.parse(get_cache("indexdata_zy_result"));
	}else{
		zy_result = get_res(zy,1).result;
		localStorage.setItem("indexdata_zy_result",JSON.stringify(zy_result));
	}
	
	if(get_cache("indexdata_jl_result") != null){
		jl_result = JSON.parse(get_cache("indexdata_jl_result"));
	}else{
		jl_result = get_res(jl,1).result;
		localStorage.setItem("indexdata_jl_result",JSON.stringify(jl_result));
	}
	
	var app = new Vue({
		el:"#app", 
		data: {
			app_tabbar: 0, 
			scrollTop: 0,
			tabactive: 1,
			show:false,
			rank_list:rank_result,
			dy_list: dy_result,
			ds_list: ds_result,
			dm_list: dm_result,
			jl_list: jl_result,
			zy_list: zy_result,
			//分页参数
			currentPage:currentPage,
			totalitems:totalitems,
			itemsperpage:itemsperpage,
			pagecount:pagecount,
			if_show:true,
			collap:'1',
			ifshow_tabs:true,
			ifshow_detail:false,
			rank_search_list:rank_search_result,
		},
		watch:{
			"tabactive":function(val){
				type=tabs[val];
				app.$set(app,'currentPage', 0);
				if(type == "rank"){
					app.$set(app,'if_show', false);
				}else{
					app.$set(app,'if_show', true);
				}
			},
		},
		methods: {
			nextpage(currentPage) {
				vant.Toast.loading({
					type: 'loading',
					duration: 300,
					message: '正在加载中...',
				});
				var comms = get_res(type,currentPage);
				switch(type){
					case dy: 
						this.origin_page('dy_list',comms);
						break;
					case ds: 
						this.origin_page('ds_list',comms);
						break;
					case dm: 
						this.origin_page('dm_list',comms);
						break;
					case zy: 
						this.origin_page('zy_list',comms);
						break;
					case jl: 
						this.origin_page('jl_list',comms);
						break;
				}
				$(".container").animate({scrollTop:"0px"},500);
			},
			origin_page(t,comms){
				app.$set(app,t, comms.result); 
				app.$set(app,'currentPage', comms.currentPage);
				app.$set(app,'totalitems', comms.totalitems); 
				app.$set(app,'itemsperpage', comms.itemsperpage); 
				app.$set(app,'pagecount', comms.pagecount); 
			},
			showSearchPanel() {
				
				window.location.href="search.html"
			},
			toplay(val){
				$.ajax({
					url:"https://api.eyunzhu.com/api/vatfs/resource_site_collect/search?kw="+val+"&per_page=50&page=1",
					type:"GET",
					async:false,
					success:function(res){
						vant.Toast.loading({
							type: 'loading',
							duration: 1000,
							message: '正在查询...',
						});
						app.$set(app,"ifshow_tabs",false);
						app.$set(app,"ifshow_detail",true);
						app.$set(app,"rank_search_list",res.data.data);
					}
				});
			},
			torank(){
				app.$set(app,"ifshow_tabs",true);
				app.$set(app,"ifshow_detail",false);
			},
		},
	});
}
		
function get_res(type,page){
	var obj=new Object();
	$.ajax({
		url:comm_url+"/base/showData/allmovies/"+type+"/"+page,
		type:'GET',
		async:false,
		success:function(res){
			var result=[];
			var totalitems = res.total;
			var itemsperpage = res.pageSize;
			var pagecount = res.pages;
			var currentPage = res.pageNum;
			for(var i = 0; i < res.list.length; i++){
				var resolve_code = res.list[i].resolve_code;
				var vnc = Base64.decode(res.list[i].video_name_cn);
				var intr = Base64.decode(res.list[i].introduce);
				var vdefinition = Base64.decode(res.list[i].video_definition);
				var online = res.list[i].online_date;
				var vtype = Base64.decode(res.list[i].video_type);
				var vid = res.list[i].video_id
				var video_name_cn;
				var introduce;
				if(vnc.length > 8){
					video_name_cn = vnc.substring(0,7)+"...";
				}else{
					video_name_cn = vnc;
				}
				if(intr.length > 8){
					introduce = intr.substring(0,12)+"...";
				}else if(intr == null || intr == '' || intr == 'null'){
					introduce = "--";
				}else{
					introduce = intr;
				}
				var video_cover = res.list[i].video_cover;
				var vobj = {
					"vtype":vtype,
					"vid":vid,
					"online":online,
					"vdefinition":vdefinition,
					"resolve_code":'player.html?path=' + resolve_code
								+"&title=" + res.list[i].video_name_cn
								+"&intro=" + res.list[i].introduce
								+"&vid=" + res.list[i].video_id
								+"&online=" + res.list[i].online_date
								+"&vtype=" + res.list[i].video_type
								+"&vdefinition=" + res.list[i].video_definition
								+"&vt=" + type
								+"&page=" + currentPage,
					"video_name_cn":video_name_cn,
					"introduce":introduce,
					"video_cover":video_cover
				};
				result.push(vobj);
			}
			obj.result=result;
			obj.totalitems=totalitems;
			obj.itemsperpage=itemsperpage;
			obj.pagecount=pagecount;
			obj.currentPage=currentPage;
		},
	});	
	return obj;
}

function get_list() {
	var obj_cache = JSON.parse(get_cache("rank_data"));
	if(obj_cache == null){
		var obj=[];
		$.ajax({
			url:'http://api.eyunzhu.com/api/vatfs/baidu_top',
			type:'GET',
			async:false,
			success:function(data){
				var c2;
				for(var i=0;i<data.data.length;i++){
					var c1;
					var c3=[];
					var list=data.data[i].data;
					for(let key in list){
						c1={key:key,hot:list[key]};
						c3.push(c1);
					}
					c2={name:data.data[i].name,list:c3};
					obj.push(c2);
				}
				set_cache("rank_data",JSON.stringify(obj));
			}
		});
		return obj;
	}else{
		var obj_1=[];
		$.ajax({
			url:'http://api.eyunzhu.com/api/vatfs/baidu_top',
			type:'GET',
			success:function(data){
				var c2;
				for(var i=0;i<data.data.length;i++){
					var c1;
					var c3=[];
					var list=data.data[i].data;
					for(let key in list){
						c1={key:key,hot:list[key]};
						c3.push(c1);
					}
					c2={name:data.data[i].name,list:c3};
					obj_1.push(c2);
				}
				set_cache("rank_data",JSON.stringify(obj_1));
			}
		});
		return obj_cache;
	}
}

var noimg=document.getElementsByTagName("img");
for(i=0; i < noimg.length; i++){
　　noimg[i].onerror=function(){this.src="./images/no.png";}
}

function shock(time){
	switch (plus.os.name) {
	    case "iOS":
			if (plus.device.model.indexOf("iPhone") >= 0 ) {
				//plus.device.vibrate(time);
			}
	    break;
	    default:
	        plus.device.vibrate(time);
	    break;
	}
}

function loadVideo(vedio_url){
	var video = document.getElementById('video');
	if(Hls.isSupported()) {
		var hls = new Hls();
		hls.loadSource(vedio_url);
		hls.attachMedia(video);
		hls.on(Hls.Events.MANIFEST_PARSED,function() {
			video.play();
		});
	} else if (video.canPlayType('application/vnd.apple.mpegurl')) {
		video.src = vedio_url;
		video.addEventListener('loadedmetadata',function() {
			video.play();
		});
	}
}